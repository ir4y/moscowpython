<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>DATA DSL HA PYTHON</title>

		<meta name="description" content="DATA DSL HA PYTHON presenatation for Moscow python conference">
		<meta name="author" content="Ilya Beda">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.css">
                <link rel="stylesheet" href="css/theme/white.css" id="theme">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

                <style>
                .two_column_code {
                  width: 45%!important;
                  display: inline-block!important;
                  margin: 10px!important;
                }
                .reveal .slide-number {
                  color: #222!important;
                  background-color: white!important;
                  font-size: 24px!important;
                }
                </style>
		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
                                        <h1>DATA DSL HA PYTHON</h1>
					<p style="float: right;">
                                          <small><a href="https://github.com/ir4y/">Илья Беда</a></small>
					</p>
				</section>

				<section>
					<h2>Кто я?</h2>
                                        <ul>
                                          <li>Разрабатываю бэкэнды на python в течение 9 лет</li>
                                          <li>Разрабатываю фронтенд на React в течение 2 лет</li>
                                          <li>Продвигаю функциональное программирование</li>
                                          <li>Провожу воркшопы и мастер-классы</li>
                                          <li>Люблю выступать на конференциях</li>
                                        </ul>
				</section>

				<section>
					<h2>Кто не любит писать шаблонный код?</h2>
                                        <img class="plain" class="plain" src="images/bollerplate.png" height="500px"/>
				</section>

				<section>
					<h2>Кто не любит, когда код работает неявно?</h2>
                                        <img class="plain" src="images/magic.png" height="500px"/>
				</section>

				<section>
					<h2>What would you like to complain about?</h2>
                                        <ul>
                                          <li>[ ] Too much magic</li>
                                          <li>[ ] Too much boilerplate </li>
                                        </ul>
				</section>

				<section>
					<h2>What would zen of python like to complain about?</h2>
                                        <ul>
                                          <li>[&#9989;] Too much magic</li>
                                          <li>[ ] Too much boilerplate </li>
                                        </ul>
				</section>

                                <section>
					<h2>What would Ilya Beda like to complain about?</h2>
                                        <ul>
                                          <li>[] Too much magic</li>
                                          <li>[&#9989;] Too much boilerplate </li>
                                        </ul>
				</section>

                                <section>
					<h2>Как же быть?</h2>
                                        <img class="plain" src="images/yin-yan.png" height="600px" />
				</section>

                                <section>
					<h2>Как нам пользоваться всей мощностью метапрограммирования и блюсти zen of python</h2>
                                        <p>в языке, совершенно не приспособленном к метапрограммированию?</p>
				</section>

                                <section>
					<h2>Метапрограммирование в других языках:</h2>
                                        <ul>
                                          <li>Ruby</li>
                                          <li>Scala</li>
                                          <li>Haskell</li>
                                          <li>Clojure</li>
                                        </ul>
				</section>

                                <section>
					<h2>Метапрограммирование в других языках:</h2>
                                        <ul>
                                          <li>Ruby</li>
                                          <li>Scala</li>
                                          <li>Haskell</li>
                                          <li><h3>Clojure</h3></li>
                                        </ul>
				</section>

                                <section>
					<h2>Clojure</h2>
                                        <img class="plain" src="images/clojure.png" height="400px"/>
				</section>

                                <section>
					<h2>Макросы в Clojure</h2>
<pre><code class="clojure">(defn is-small? [number]
  (if (&lt; number 100) "yes" "no"))
</code></pre>
				</section>
                                <section>
					<h2>Макросы в Clojure</h2>
<pre><code class="clojure">(defn hello-bill [user-name]
  (when (= user-name "bill")
    (println "hello bill")))
</code></pre>
				</section>

                                <section>
					<h2>Макросы в Clojure</h2>
<pre><code class="clojure">(macroexpand '(when (= user-name "bill")
		(println "hello bill")))

(if (= user-name "bill")
	(do (println "hello bill")))
</code></pre>
				</section>
                                <section>
					<h2>Макросы в Clojure</h2>
<pre><code class="clojure">(defn hello-bill [user-name]
  (when (= user-name "bill")
    (println "hello bill")))

(defn hello-bill [user-name]
    (if (= user-name "bill")
	(do (println "hello bill"))))
</code></pre>
				</section>

                                 <section>
                                       <h2>Почему мы не делаем так в python?</h2>
				</section>
                                 <section>
                                       <h2>Возможность такая есть</h2>
                                       <pre><code class="python">from patterns import patterns

@patterns
def factorial():
    if 0: 1
    if n is int: n * factorial(n-1)
    if []: []
    if [x] + xs: [factorial(x)] + factorial(xs)
    if {'n': n, 'f': f}: f(factorial(n))
</code></pre>
				</section>
                                 <section>
                                       <h2>Возможность такая есть</h2>
                                       <pre><code class="python">def factorial(n):
    if n == 0: return 1
    if isinstance(n, int): return n * factorial(n-1)
    if n == []: return []
    if isinstance(n, list): return [factorial(x[0])] \
                                   + factorial(x[1:])
    if isinstance(n, dict): return n['f'](factorial(n['n']))
</code></pre>
				</section>

                                 <section>
                                       <h2>Почему мы не делаем так в python</h2>
                                   <img class="plain" src="images/question_mark.png" height="500px"/>
				</section>

                                 <section>
                                       <h2>Python source code</h2>
<pre><code>def is_small(number):
    if number &lt; 100:
        return "yes"
    else:
        return "no"
</code></pre>
				</section>


                                 <section>
                                       <h2>Python AST</h2>
<pre><code>Function(None, 'is_small', ['number'], 0, None,
  Stmt(If(Compare(Name('number'),
                    '&lt;',
                    Const(100)
                  ),
          Stmt(
            Return(
              Const('yes')
            )
          ),
          Stmt(
            Return(
              Const('no')
            )))))
</pre></code>
				 </section>

                                 <section>
                                       <h2>Не все так просто</h2>
                                 </section>


                                 <section>
                                       <h2>Homoiconicity</h2>
                                 </section>

                                 <section>
                                       <h2>Clojure source code</h2>
<pre><code class="clojure">(defn is-small? [number]
  (if (&lt; number 100) "yes" "no"))
</code></pre>
                                 </section>
                                 <section>
                                       <h2>Clojure AST</h2>
<pre><code class="clojure">'(defn is-small? [number]
  (if (&lt; number 100) "yes" "no"))
</code></pre>

                                 </section>





                                 <section>
                                       <h2>В python никогда не будет Гомоиконности</h2>
				 </section>


                                 <section>
                                       <h2>В python никогда не будет Гомоиконности</h2>
                                       <p>Как и нормального метапрограммирования</p>
                                 </section>

                                 <section>
                                       <h2>Спасибо за внимание</h2>
                                 </section>

                                 <section>
                                       <h2>Спасибо за внимание?</h2>
                                 </section>

                                 <section>
                                       <h2>Data DSL</h2>
                                       <img class="plain" src="images/data_dsl.png"/>
                                 </section>

                                 <section>
                                   <h2>hiccup</h2>
                                   <pre><code class="clojure">(html [:span {:class "foo"} "bar"])</code></pre>
                                 </section>

                                 <section>
                                   <h2>hiccup-py</h2>
                                   <pre><code class="python">html(["span", {"class": "foo"} "bar"])</code></pre>
                                 </section>

                                 <section>
                                   <h2>hiccup-py</h2>
                                   <p>48 lines of code</p>
                                 </section>

                                 <section>
                                   <h2>Примеры DATA DSL на python</h2>
                                   http://docs.python-cerberus.org/en/stable/schemas.html
                                   http://python-eve.org/quickstart.html
                                 </section>

                                 <section>
                                   <h2>python-cerberus</h2>
                                   <pre><code class="python">schema = {'name': {'type': 'string', 'maxlength': 10}}</code></pre>
                                 </section>

                                 <section>
                                   <h2>eve</h2>
                                   <pre><code class="python">DOMAIN = {
    'works':  {
        'cache_control': 'max-age=10,must-revalidate',
        'cache_expires': 10,
        'additional_lookup': {
            'url': 'regex("[\w]+")',
            'field': 'title'
        },
        'schema': {
            'title': {
                'type': 'string',
                'required': True,
            }
        }
    }
}
</code></pre></section>




                                 <section>
                                   <h2>Насколько это подходит для решения повседневных задач?</h2>
                                 </section>

                                 <section>
                                   <h2>Новости</h2>
                                   <img class="plain" src="images/news.png" height="600px" />
                                 </section>

                                 <section>
                                   <h2>Заметки</h2>
                                   <img class="plain" src="images/notes.png" height="600px" />
                                 </section>

                                 <section>
                                   <h2>Галерея</h2>
                                   <img class="plain" src="images/gallery.png" height="600px" />
                                 </section>

                                 <section>
                                   <h2>Документы</h2>
                                   <img class="plain" src="images/files.png" height="600px" />
                                 </section>

                                 <section>
                                   <h2>Задача</h2>
                                   <p> Новости (wysiwys, есть подблоки текста c wysiwys)</p>
                                   <p> Заметки (нет wysiwys, есть подблоки текста)</p>
                                   <p> Галерея (нет wysiwys, есть подблоки изображения)</p>
                                   <p> Документы (нет wysiwys, есть подблоки файлы)</p>
                                 </section>

                                 <section>
                                   <h2>Что будет завтра?</h2>
                                 </section>

                                 <section>
                                   <h2>Что будет завтра?</h2>
                                   <img class="plain" src="images/news_with_image.png" height="600px" />
                                 </section>

                                 <section>
                                   <h2>Что будет завтра?</h2>
                                   <img class="plain" src="images/nodes_docs.png" height="600px" />
                                 </section>

                                  <section>
                                    <h2>Модель</h2>
                                    <ul>
                                      <li>группа</li>
                                      <li>текстовое поле</li>
                                      <li>подблоки текст</li>
                                      <li>подблоки изображения</li>
                                      <li>подблоки файлы</li>
                                    </ul>
                                  </section>

                                  <section>
                                    <h2>Админка</h2>
                                   <img class="plain" src="images/admin.png" height="600px" />
                                  </section>

                                  <section>
                                    <h2>Админка для новостей</h2>
                                   <img class="plain" src="images/admin_news.png" height="600px" />
                                  </section>
                                  <section>
                                    <h2>Админка для заметок</h2>
                                   <img class="plain" src="images/admin_notes.png" height="600px" />
                                  </section>
                                  <section>
                                    <h2>Админка для галерей</h2>
                                   <img class="plain" src="images/admin_gallery.png" height="600px" />
                                  </section>
                                  <section>
                                    <h2>Админка для файлов</h2>
                                   <img class="plain" src="images/admin_files.png" height="600px" />
                                  </section>

                                   <section>
                                    <h2>Нужна кастомизация</h2>
                                    <ul>
                                      <li>Прокси модель на каждый случай</li>
                                      <li>Миксин на каждую опцию для админки</li>
                                      <li>Админка для каждой прокси модели со своим набором миксинов</li>
                                    </ul>
                                  </section>

                                  <section>
                                    <h2>Нужна кастомизация</h2>
                                    <p>У нас уже есть формализованное знание</p>
                                  </section>

                                  <section>
                                    <h2>У нас уже есть формализованное знание</h2>
                                    <p> Новости (wysiwys, есть подблоки текста c wysiwys)</p>
                                    <p> Заметки (нет wysiwys, есть подблоки текста)</p>
                                    <p> Галерея (нет wysiwys, есть подблоки изображения)</p>
                                    <p> Документы (нет wysiwys, есть подблоки файлы)</p>
                                  </section>

                                  <section>
                                    <h2>Опишем структурой данных</h2>
<pre class="two_column_code"><code class="python">GROUP_SCHEMA = {
    'News': {
        'wysiwyg': True,
        'has_images': False,
        'has_files': False,
        'has_subblock': True,
    },
    'Note': {
        'wysiwyg': False,
        'has_images': False,
        'has_files': False,
        'has_subblock': True,
    },

</code></pre><pre class="two_column_code"><code class="python">
    'Gallery': {
        'wysiwyg': False,
        'has_images': True,
        'has_files': False,
        'has_subblock': False,
    },
    'Document': {
        'wysiwyg': False,
        'has_images': False,
        'has_files': True,
        'has_subblock': False,
    }
}
</code></pre>
                                  </section>

                                  <section>
                                    <h2>Пишем интерпретатор</h2>
                                    <pre><code class="python" style="max-height: 600px;">01 def create_flatblock_for_group_model(name, group_info):
02     class GroupBlockManager(models.Manager):
03         def get_queryset(self):
04             return super(GroupBlockManager, self)\
05                 .get_queryset()\
06                 .filter(group=name.lower())
07     class GroupBlockMeta:
08         proxy = True
09         verbose_name = name
10         verbose_name_plural = group_info.get(
11             'verbose_name_plural')
12
13     class_name = '{}Block'.format(name)
14     return type(class_name,
15                 (Block, ),
16                 {
17                     'objects': GroupBlockManager(),
18                     '__module__': __name__,
19                     'Meta': GroupBlockMeta
20                 })
21
22 group_models = {name: create_flatblock_for_group_model(
23     name, group) for name, group in group_schema.items()}
</code></pre>
                                  </section>
                                  <section>
                                    <h2>Пишем интерпретатор</h2>
                                    <pre><code class="python" style="max-height: 600px;">01 build_admin_class(name, group_info):
02     bases = []
03     inlines = []
04
05    if group_info['wysiwyg']:
06        bases.append(AdminWysiwygMixin)
07    if group_info['has_images']:
08        inlines.append(BlockImageInline)
09    if group_info['has_files']:
10        inlines.append(BlockFileInline)
11    if group_info['has_subblock']:
12        inlines.append(SubBlockWysiwygAdmin
13             if group_info['wysiwyg'] else SubBlockAdmin)
14
15    bases.append(ModelAdmin)
16
17    return type('{}ModelAdmin'.format(name),
18                tuple(bases),
19                {'inlines': inlines})
20
21
22 for name, group_info in group_schema.items():
23    admin.site.register(group_models[name],
24                        build_admin_class(name, group_info))
</code></pre>
                                  </section>
				<section>
					<h2>API</h2>
<pre class="two_column_code"><code class="python">GROUP_SCHEMA = {
    'News': {
        'wysiwyg': True,
        'has_images': False,
        'has_files': False,
        'has_subblock': True,
    },
    'Note': {
        'wysiwyg': False,
        'has_images': False,
        'has_files': False,
        'has_subblock': True,
    },

</code></pre><pre class="two_column_code"><code class="python">
    'Gallery': {
        'wysiwyg': False,
        'has_images': True,
        'has_files': False,
        'has_subblock': False,
    },
    'Document': {
        'wysiwyg': False,
        'has_images': False,
        'has_files': True,
        'has_subblock': False,
    }
}
</code></pre>

				</section>

				<section>
					<h2>Абстракция может быть выше</h2>
<pre class="two_column_code"><code class="yaml">News:
  wysiwyg: true
  has_images: false
  has_files: false
  has_subblock: true
Note:
  wysiwyg: false
  has_images: false
  has_files: false
  has_subblock: true
</code></pre>
<pre class="two_column_code"><code class="yaml">Gallery:
  wysiwyg: false
  has_images: true
  has_files: false
  has_subblock: false
Document:
  wysiwyg: false
  has_images: false
  has_files: true
  has_subblock: false
</code></pre>
				</section>
                                  <section>
                                    <h2>Абстракция может быть ЕЩЕ выше</h2>
                                    <pre><code class="python">GROUP_SCHEMA = GroupSchema.objects.as_schema()</code></pre>
                                  </section>

				<section>
					<h2>Ваши вопросы</h2>
      			                <p>
                                          <small><a href="https://github.com/ir4y/hicupp-py">https://github.com/ir4y/hicupp-py</a></small><br/>
                                          <small><a href="https://github.com/ir4y/blocks">https://github.com/ir4y/blocks</a></small><br/>
                                          <small><a href="https://twitter.com/ir4y_ix">@ir4y_ix</a></small><br/>
					</p>
				</section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: false, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});
                        Reveal.configure({ slideNumber: true });
                </script>

	</body>
</html>
